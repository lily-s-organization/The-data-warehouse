<script src="~/Scripts/bootstrap.min.js"></script>
<div id="dataBind" ng-app="myapp" ng-controller="myCtrl">

    <form name="myForm">
        <h2 style="text-align:center;margin-bottom:20px">修改用户 </h2>
        <div class="container">
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">姓名</label>
                <div class="col-md-6">
                    <input type="text" name="usernameInput" class="form-control" ng-model="user.UserName" required />
                    <span ng-show="myForm.usernameInput.$touched && myForm.usernameInput.$invalid">请填写姓名</span>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">Email</label>
                <div class="col-md-6">
                    <input name="emailInput" type="email" class="form-control" ng-model="user.Email" required />
                    <span ng-show="!myForm.emailInput.$valid">错误格式</span>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">密码</label>
                <div class="col-md-6">
                    <input type="password" class="form-control" ng-model="user.PassWord" ng-minlength="6" name="passwordInput" required />
                    <span ng-show="myForm.passwordInput.$touched && myForm.passwordInput.$invalid">最少六位</span>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">角色</label>
                <div class="col-md-6">
                    <select ng-model="user.RoleType" ng-options="x.Text for x in names" name="roletypeInput"  ng-change="roleSelected()"></select>
                    <span ng-show="myForm.roletypeInput.$touched && myForm.roletypeInput.$invalid" class="help-block">请选择一个角色</span>
                </div>
            </div>
            <div class="form-group row" ng-show="hiddenSelelctList">
                <label class="col-md-1 col-md-offset-2 col-form-label">讲师列表</label>
                <div class="col-md-6">
                    <select ng-model="user.Teacher" ng-options="x.TeacherName for x in teacherList" name="teacherInput" ng-change="teacherSelected()" required>
                        <option value="">{{teacherName}}</option>
                    </select>
                    <span ng-show="myForm.teacherInput.$touched && myForm.teacherInput.$invalid" class="help-block">请选择一个讲师</span>
                </div>
            </div>

            <div class="form-group row">
                <div class="col-md-offset-5" style="padding-left:20px">
                    <input type="submit" class="btn btn-primary" value="保存" ng-click="saveUser()" />
                    <input type="button" class="btn btn-danger" value="取消" ng-click="cancelSubmit()" />
                </div>
            </div>
        </div>
    </form>


   

</div>


<script>

    var app = angular.module("myapp", []);
    app.controller("myCtrl", function ($scope, $http) {
     
        $scope.Id = '@ViewBag.Id';
        var id = $scope.Id;
        $scope.teacherName = "请选择";
       // getRoleTypeList($scope, $http);//初始化下拉列表
        getUserDetail($scope, $http);
       

        $scope.saveUser = function () {

            saveUser($scope, $http);

        };
        $scope.cancelSubmit = function () {
            window.location.href = "@Url.Content("~/MoocAdmin/Users/Index/")";
        };

        $scope.teacherSelected = function () {

            $scope.teacherId = $scope.user.Teacher.Id;

        };

        $scope.roleSelected = function () {

            if ($scope.user.RoleType.Value == 2) {
                //console.log($scope.selectedName.Value);
                $scope.hiddenSelelctList = true;
            }
            else {
                $scope.hiddenSelelctList = false;
                $scope.teacherId = -1;
            }
        };

    });



    function getRoleTypeList($scope, $http) {

        $http({
            method: 'GET',
            url: "@Url.Content("~/MoocAdmin/Users/GetRoleTypeList")",
        }).then(function (response) {
            if (response.status == 200) {
                $scope.names = response.data.roleList;    
                console.log($scope.names);
            }
        }, function (data) {
            console.log(data);
        });
    }

    function getUserDetail($scope, $http) {

        $http({
            method: 'POST',
            url: "@Url.Content("~/MoocAdmin/Users/GetUserDetail")",
            data: {"id":$scope.Id},
        }).then(function (response) {
            if (response.status == 200) {
                $scope.user = response.data.userInfo;              
                $scope.names = response.data.roleList;
                $scope.user.RoleType = $scope.names[($scope.user.RoleType - 1)]; //初始化select列表的默认选中项，因为RoleTypes是1到3，为了对应数组下标，所以减去1               
                if ($scope.user.RoleType.Value == 2) {
                    $scope.hiddenSelelctList = true;   //如果不是讲师 则不显示讲师列表下拉框
                    $scope.teacherId = -1;
                }  
                $scope.teacherList = response.data.teacherList;
                console.log($scope.teacherList);
                if (response.data.teacherInfo.teacherName == null && response.data.teacherInfo.teacherId== null) {     //用户注册时不是讲师 但是在Update时关联讲师账户
                    $scope.teacherName = "请选择";
                }
                else {
                    $scope.teacherName = response.data.teacherInfo.teacherName;
                    $scope.teacherId = -1;
                }
              
              

            }
        }, function (data) {
            console.log(data);
        });
    }

    function saveUser($scope, $http) {

        var user = {
            UserName: $scope.user.UserName,
            Email: $scope.user.Email,
            PassWord: $scope.user.PassWord,
            RoleType: $scope.user.RoleType.Value,
            Id: $scope.Id,          
            PhotoUrl: $scope.user.PhotoUrl,
            TeacherId: $scope.teacherId
        };

        $http({
            method: 'POST',
            url: "@Url.Content("~/MoocAdmin/Users/AddUserList")",
            data: JSON.stringify(user),
            dataType: "json"
        }).then(function (response) {
            if (response.status == 200) {
                alert("更新成功");
                window.location.href = "@Url.Content("~/MoocAdmin/Users/Index/")";
            }
        }, function (data) {
            console.log(data);
        });
    }


</script>

