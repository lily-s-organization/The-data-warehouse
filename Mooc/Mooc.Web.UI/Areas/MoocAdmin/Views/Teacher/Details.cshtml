<script src="~/Scripts/bootstrap.min.js"></script>
<div id="dataBind" ng-app="myapp" ng-controller="myCtrl">
    <form name="myForm" >
        <h2 style="text-align:center;margin-bottom:20px">修改讲师信息 </h2>
        <div class="container">
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">姓名</label>
                <div class="col-md-6">
                    <input type="text" class="form-control" name="TeacherName" ng-model="teacher.TeacherName" required>
                    <span ng-show="myForm.TeacherName.$touched && myForm.TeacherName.$invalid" class="help-block">请填写姓名</span>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">Email</label>
                <div class="col-md-6">
                    <input type="email" class="form-control" name="Email" ng-model="teacher.Email" required>
                    <span ng-show="myForm.Email.$touched && myForm.Email.$invalid" class="help-block">错误格式</span>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">身份</label>
                <div class="col-md-6">
                    <input type="text" class="form-control" ng-model="teacher.Level" name="Level">
                </div>
            </div>
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">部门</label>
                <div class="col-md-6">
                    <input type="text" class="form-control" ng-model="teacher.Department" name="Department" required>
                    <span ng-show="myForm.Department.$touched && myForm.Department.$invalid" class="help-block">请填写一个部门</span>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">头像</label>
                <div class="col-md-6">
                    <img ng-src="~/Images/Upload/{{teacher.PhotoUrl}}" style="max-height:250px;max-width:250px;" />
                </div>
            </div>
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">头像</label>
                <div class="col-md-6">
                    <input type="file" name="ImageUpload" id="ImageUpload"
                           onchange="angular.element(this).scope().imgSelected()" />
                </div>
            </div>
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">个人简介</label>
                <div class="col-md-6">
                    <input type="text" class="form-control" ng-model="teacher.Description" name="Description">
                </div>
            </div>
            <input type="hidden" class="form-control" name="Id" value="{{teacher.Id}}" >
            <div class="form-group row">
                <div class="col-md-offset-5" style="padding-left:20px;">
                    <input type="button" class="btn btn-primary" value="保存"  ng-click="updateTeacher()" />
                    <input type="button" class="btn btn-danger" value="取消" ng-click="cancelSubmit()"  />
                </div>
            </div>
        </div>
    </form>

</div>


<script>

    var app = angular.module("myapp", []);
    app.controller("myCtrl", function ($scope, $http) {

        $scope.Id = '@ViewBag.Id';
        var id = $scope.Id;

        getTeacherDetail($scope, $http);

        $scope.updateTeacher = function () {
            updateTeacher($scope, $http);
        };
  
        $scope.cancelSubmit = function () {
            window.location.href = "@Url.Content("~/MoocAdmin/Teacher/Index/")";
        };

         $scope.imgSelected = function () {
              
            var fd = new FormData();
            var file = document.querySelector('input[type=file]').files[0];
             fd.append('ImageUpload', file);
             fd.append("PhotoUrl", $scope.teacher.PhotoUrl);
             $http({
            method: 'POST',
                 url: "@Url.Content("~/MoocAdmin/Teacher/AddPhoto")",
                 data: fd,
                 headers: { 'Content-Type': undefined },
                 transformRequest: angular.identity ,
                 dataType: "json"
        }).then(function (response) {
            if (response.status == 200) {
                //alert("头像添加成功");
                console.log(response.data.url);
                $scope.teacher.PhotoUrl = response.data.url;
            }
        }, function (data) {
            console.log(data);
        });
        }

    });

    function updateTeacher($scope, $http) {
        var teacher = {
            TeacherName: $scope.teacher.TeacherName,
            Email: $scope.teacher.Email,
            PhotoUrl: $scope.teacher.PhotoUrl,
            Level: $scope.teacher.Level,
            Department: $scope.teacher.Department,
            Description: $scope.teacher.Description,
            Id: $scope.teacher.Id

        };

        $http({
            method: 'POST',
            url: "@Url.Content("~/MoocAdmin/Teacher/AddTeacherList")",
            data: JSON.stringify(teacher),
            dataType: "json"
        }).then(function (response) {
            if (response.status == 200) {
                if (response.data.code == 200) {
                    alert("修改讲师成功");
                    window.location.href = "@Url.Content("~/MoocAdmin/Teacher/Index/")";
                }
                else {
                    alert("修改失败");
                }
            }
        }, function (data) {
            console.log(data);
        });

    }

    function getTeacherDetail($scope, $http) {

        $http({
            method: 'POST',
            url: "@Url.Content("~/MoocAdmin/Teacher/GetTeacherDetail")",
            data: {"id":$scope.Id},
        }).then(function (response) {
            if (response.status == 200) {
                $scope.teacher = response.data;            
                console.log($scope.teacher);
                console.log(response);
            }
        }, function (data) {
            console.log(data);
        });
    }

   


</script>

