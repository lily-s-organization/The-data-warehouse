
<div ng-app="myapp" ng-controller="myCtrl">
    <div name="myForm">
        <h2 style="text-align:center;margin-bottom:20px">添加讲师 </h2>
        <div class="container">
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">姓名</label>
                <div class="col-md-6">
                    <input type="text" class="form-control" name="TeacherName" ng-model="TeacherName" required>
                    <span ng-show="myForm.TeacherName.$touched && myForm.TeacherName.$invalid" class="help-block">请填写姓名</span>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">Email</label>
                <div class="col-md-6">
                    <input type="email" class="form-control" name="Email" ng-model="Email" required>
                    <span ng-show="myForm.Email.$touched && myForm.Email.$invalid" class="help-block">错误格式</span>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">身份</label>
                <div class="col-md-6">
                    <input type="text" class="form-control" name="Level" ng-model="Level">
                </div>
            </div>
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">部门</label>
                <div class="col-md-6">
                    <input type="text" class="form-control" name="Department" ng-model="Department" required>
                    <span ng-show="myForm.Department.$touched && myForm.Department.$invalid" class="help-block">请选择一个部门</span>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">头像</label>
                <div class="col-md-6">

                    <input type="file"  accept="image/*" file-model="images" onchange="angular.element(this).scope().img_upload(this.files)" />

                    @*<input type="file" name="ImageUpload" id="ImageUpload"
                        onchange="angular.element(this).scope().imgSelected()" accept="image/*" />*@

                </div>
            </div>
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label" style="margin-top:5px">个人简介</label>
                <div class="col-md-6">
                    <input type="text" class="form-control" ng-model="Description" name="Description">
                </div>
            </div>

            <div class="form-group row">
                <div class="col-md-offset-5" style="padding-left:20px;">
                    <input type="button" id="submitBtn" class="btn btn-primary" value="保存" ng-click="saveTeacher()" />
                    <input type="button" class="btn btn-danger" value="取消" ng-click="cancelSubmit()" />
                </div>
            </div>
        </div>
    </div>
</div>


<script>

    var app = angular.module("myapp", []);
    app.controller("myCtrl", function ($scope, $http) {
        $scope.reader = new FileReader();

        $scope.saveTeacher = function () {
            saveTeacher($scope, $http);
        };

        $scope.cancelSubmit = function () {
            window.location.href = "@Url.Content("~/MoocAdmin/Teacher/Index/")";
        };

        $scope.img_upload = function (files) {       //单次提交图片的函数
            //$scope.guid = (new Date()).valueOf();   //通过时间戳创建一个随机数，作为键名使用
            //$scope.reader.readAsDataURL(files[0]);  //FileReader的方法，把图片转成base64
            //$scope.reader.onload = function (ev) {
            //    $scope.$apply(function () {
            //        $scope.thumb[$scope.guid] = {
            //            imgSrc: ev.target.result,  //接收base64
            //        }
            //    });
            //};

            
            var data = new FormData();      //以下为像后台提交图片数据
            data.append('ImageUpload', files[0]);
            data.append('PhotoUrl', '');
            $http({
                method: 'post',
                url: "@Url.Content("~/MoocAdmin/Teacher/AddPhoto")",
                data: data,
                headers: { 'Content-Type': undefined },
                transformRequest: angular.identity
            }).then(function (response) {
                debugger
                console.log(response);
                if (response.status == 200) {
                    //alert("头像添加成功");
                   // console.log(response.data.url);
                   // $scope.PhotoUrl = response.data.url;
                }
            }, function (data) {
                console.log(data);
            });
            return false;
        };

        $scope.imgSelected = function (files) {


            var fd = new FormData();
            var file = document.querySelector('input[type=file]').files[0];
            if (file) {
                fd.append('ImageUpload', file);
                fd.append("PhotoUrl", "NewPhoto");
                $http({
                    method: 'POST',
                    url: "@Url.Content("~/MoocAdmin/Teacher/AddPhoto")",
                    data: fd,
                    headers: { 'Content-Type': undefined },
                    transformRequest: angular.identity,
                    dataType: "json"
                }).then(function (response) {
                    if (response.status == 200) {
                        //alert("头像添加成功");
                        console.log(response.data.url);
                        $scope.PhotoUrl = response.data.url;
                    }
                }, function (data) {
                    console.log(data);
                });
            }

        }

    });

    function saveTeacher($scope, $http) {
        var teacher = {
            TeacherName: $scope.TeacherName,
            Email: $scope.Email,
            PhotoUrl: $scope.PhotoUrl,
            Level: $scope.Level,
            Department: $scope.Department,
            Description: $scope.Description,

        };
        debugger;
        $http({
            method: 'POST',
            url: "@Url.Content("~/MoocAdmin/Teacher/AddTeacherList")",
            data: JSON.stringify(teacher),
            dataType: "json"
        }).then(function (response) {
            if (response.status == 200) {
                if (response.data.code == 200) {
                    alert("添加讲师成功");
                    window.location.href = "@Url.Content("~/MoocAdmin/Teacher/Index/")";
                }
                else {
                    alert("添加失败");
                }
            }
        }, function (data) {
            console.log(data);
        });

    }


</script>
