
<script src="~/Scripts/bootstrap.min.js"></script>
<div id="dataBind" ng-app="myapp" ng-controller="myCtrl">
    <form name="myForm">
        <h2 style="text-align:center;margin-bottom:20px">修改课程信息 </h2>
        <div class="container">
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">课程名</label>
                <div class="col-md-6">
                    <input type="text" name="subjectnameInput" class="form-control" ng-model="subject.SubjectName" required />
                    <span ng-show="myForm.subjectnameInput.$touched && myForm.subjectnameInput.$invalid" class="help-block">请填写课程名</span>
                </div>
            </div>
            i<div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">课程简介</label>
                <div class="col-md-6">
                    <input type="text" class="form-control" ng-model="subject.Description" />
                </div>
            </div>
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">课程封面</label>
                <div class="col-md-6">
                    <img ng-src="{{subject.PhotoUrl|trustUrl}}"  style="max-height:250px;max-width:250px;" />
                </div>
            </div>
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">更新封面</label>
                <div class="col-md-6">
                    <input type="file" name="ImageUpload" id="ImageUpload"
                           onchange="angular.element(this).scope().imgSelected()" />
                </div>
            </div>
            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">课程类别</label>
                <div class="col-md-6">
                    <select ng-model="CategoryName" ng-options="x.name for x in subjectCategory" name="categoryInput" ng-change="categorySelected()">
                        <option value="">{{subject.CategoryName}}</option>
                    </select>
                    <span ng-show="myForm.categoryInput.$touched && myForm.categoryInput.$invalid" class="help-block">请选择一个课程类别</span>
                </div>
            </div>

            <div class="form-group row">
                <label class="col-md-1 col-md-offset-2 col-form-label">讲师</label>
                <div class="col-md-6">
                    <select ng-model="TeacherName" ng-options="x.name for x in teacherList" name="teacherInput" ng-change="teacherSelected()">
                        <option value="">{{subject.TeacherName}}</option>
                    </select>
                    <span ng-show="myForm.teacherInput.$touched && myForm.teacherInput.$invalid" class="help-block">请选择一个讲师</span>
                </div>
            </div>

            <input type="hidden" class="form-control" name="Id" value="{{subject.Id}}">
            <div class="form-group row">
                <div class="col-md-offset-5" style="padding-left:20px;">
                    <input type="button" class="btn btn-primary" value="保存" ng-click="updateSubject()" />
                    <input type="button" class="btn btn-danger" value="取消" ng-click="cancelSubmit()" />
                </div>
            </div>
        </div>
    </form>

</div>


<script>

    var app = angular.module("myapp", []);
    app.controller("myCtrl", function ($scope, $http) {

        $scope.Id = '@ViewBag.Id';
        var id = $scope.Id;
        getSubjectDetail($scope, $http);
        initSelectList($scope, $http); //初始化下拉列表

        $scope.categorySelected = function () {
            console.log($scope.CategoryName.id);
            $scope.categoryId = $scope.CategoryName.id;
        }

        $scope.teacherSelected = function () {
            console.log($scope.TeacherName.id);
            $scope.teacherId = $scope.TeacherName.id;
        }

        $scope.updateSubject = function () {
            updateSubject($scope, $http);
        };

        $scope.cancelSubmit = function () {
            window.location.href = "@Url.Content("~/MoocAdmin/Subject/Index/")";
        };

        $scope.imgSelected = function () {

            var fd = new FormData();
            var file = document.querySelector('input[type=file]').files[0];
            fd.append('ImageUpload', file);
            fd.append("PhotoUrl", $scope.subject.PhotoUrl);

            $http({
                method: 'POST',
                url: "@Url.Content("~/MoocAdmin/Subject/AddPhoto")",
                data: fd,
                headers: { 'Content-Type': undefined },
                transformRequest: angular.identity,
                //dataType: "json"
            }).then(function (response) {
                debugger
                if (response.status == 200) {
                    //alert("头像添加成功");
                    console.log(response.data.url);
                    $scope.subject.PhotoUrl = response.data.url;
                }
            }, function (data) {
                console.log(data);
            });
        }

    });

    function initSelectList($scope, $http) {

        $http({
            method: 'GET',
            url: "@Url.Content("~/MoocAdmin/Subject/InitSelectList")",
        }).then(function (response) {
            if (response.status == 200) {
                $scope.teacherList = response.data.teacherList;
                $scope.subjectCategory = response.data.subjectCategory;

            }
        }, function (data) {
            console.log(data);
        });
    }

    function updateSubject($scope, $http) {

        var subject = {
            SubjectName: $scope.subject.SubjectName,
            Description: $scope.subject.Description,
            PhotoUrl: $scope.subject.PhotoUrl,
            teacherId: $scope.teacherId,
            categoryId: $scope.categoryId,
            Id: $scope.subject.Id
        };

        $http({
            method: 'POST',
            url: "@Url.Content("~/MoocAdmin/Subject/AddSubjectList")",
            data: JSON.stringify(subject),
            dataType: "json"
        }).then(function (response) {
            if (response.status == 200) {
                if (response.data.code == 200) {
                    alert("修改课程成功");
                    window.location.href = "@Url.Content("~/MoocAdmin/Subject/Index/")";
                }
                else {
                    alert("修改失败");
                }
            }
        }, function (data) {
            console.log(data);
        });

    }

    function getSubjectDetail($scope, $http) {

        $http({
            method: 'POST',
            url: "@Url.Content("~/MoocAdmin/Subject/getSubjectDetail")",
            data: { "id": $scope.Id },
        }).then(function (response) {
            if (response.status == 200) {
                $scope.subject = response.data;
                console.log($scope.subject);
                console.log($scope.subject.CategoryName);
                $scope.categoryId = response.data.CategoryId;
                $scope.teacherId = response.data.TeacherId;
                // console.log(response);
            }
        }, function (data) {
            console.log(data);
        });
    }

    app.filter("trustUrl", ['$sce', function ($sce) {
        return function (recordingUrl) {
            return $sce.trustAsResourceUrl(recordingUrl);
        };
    }]);



</script>

